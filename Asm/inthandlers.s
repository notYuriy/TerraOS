bits 64
extern idt_dispatcher

%macro define_int_no_err_code_handler 1
global int%1_handler
int%1_handler:
        push qword 0
        push rax
        mov rax, %1
        jmp int_handler_stub
%endmacro

%macro define_int_err_code_handler 1
global int%1_handler
int%1_handler:
        push rax
        mov rax, %1
        jmp int_handler_stub
%endmacro

int_handler_stub:
        push rbx
        push rcx
        push rdx
        push rdi
        push rsi
        push rbp
        push r8
        push r9
        push r10
        push r11
        push r12
        push r13
        push r14
        push r15
        mov rbx, cr0
        push rbx
        mov rbx, cr2
        push rbx
        mov rbx, cr3
        push rbx
        mov rbx, cr4
        push rbx
        push rax
        mov rdi, rsp
        call idt_dispatcher
        pop rax
        pop rax
        pop rax
        mov rbx, cr3
        cmp rax, rbx
        je .next
        mov cr3, rax
        invlpg [rax]
.next:
        pop rax
        pop rax
        pop r15
        pop r14
        pop r13
        pop r12
        pop r11
        pop r10
        pop r9
        pop r8
        pop rbp
        pop rsi
        pop rdi
        pop rdx
        pop rcx
        pop rbx
        pop rax
        add rsp, 8
        iretq

; this code was autogenerated
; it is probably the only way to do it
define_int_no_err_code_handler 0
define_int_no_err_code_handler 1
define_int_no_err_code_handler 2
define_int_no_err_code_handler 3
define_int_no_err_code_handler 4
define_int_no_err_code_handler 5
define_int_no_err_code_handler 6
define_int_no_err_code_handler 7
define_int_err_code_handler 8
define_int_no_err_code_handler 9
define_int_err_code_handler 10
define_int_err_code_handler 11
define_int_err_code_handler 12
define_int_err_code_handler 13
define_int_err_code_handler 14
define_int_no_err_code_handler 15
define_int_no_err_code_handler 16
define_int_err_code_handler 17
define_int_no_err_code_handler 18
define_int_no_err_code_handler 19
define_int_no_err_code_handler 20
define_int_no_err_code_handler 21
define_int_no_err_code_handler 22
define_int_no_err_code_handler 23
define_int_no_err_code_handler 24
define_int_no_err_code_handler 25
define_int_no_err_code_handler 26
define_int_no_err_code_handler 27
define_int_no_err_code_handler 28
define_int_no_err_code_handler 29
define_int_err_code_handler 30
define_int_no_err_code_handler 31
define_int_no_err_code_handler 32
define_int_no_err_code_handler 33
define_int_no_err_code_handler 34
define_int_no_err_code_handler 35
define_int_no_err_code_handler 36
define_int_no_err_code_handler 37
define_int_no_err_code_handler 38
define_int_no_err_code_handler 39
define_int_no_err_code_handler 40
define_int_no_err_code_handler 41
define_int_no_err_code_handler 42
define_int_no_err_code_handler 43
define_int_no_err_code_handler 44
define_int_no_err_code_handler 45
define_int_no_err_code_handler 46
define_int_no_err_code_handler 47
define_int_no_err_code_handler 48
define_int_no_err_code_handler 49
define_int_no_err_code_handler 50
define_int_no_err_code_handler 51
define_int_no_err_code_handler 52
define_int_no_err_code_handler 53
define_int_no_err_code_handler 54
define_int_no_err_code_handler 55
define_int_no_err_code_handler 56
define_int_no_err_code_handler 57
define_int_no_err_code_handler 58
define_int_no_err_code_handler 59
define_int_no_err_code_handler 60
define_int_no_err_code_handler 61
define_int_no_err_code_handler 62
define_int_no_err_code_handler 63
define_int_no_err_code_handler 64
define_int_no_err_code_handler 65
define_int_no_err_code_handler 66
define_int_no_err_code_handler 67
define_int_no_err_code_handler 68
define_int_no_err_code_handler 69
define_int_no_err_code_handler 70
define_int_no_err_code_handler 71
define_int_no_err_code_handler 72
define_int_no_err_code_handler 73
define_int_no_err_code_handler 74
define_int_no_err_code_handler 75
define_int_no_err_code_handler 76
define_int_no_err_code_handler 77
define_int_no_err_code_handler 78
define_int_no_err_code_handler 79
define_int_no_err_code_handler 80
define_int_no_err_code_handler 81
define_int_no_err_code_handler 82
define_int_no_err_code_handler 83
define_int_no_err_code_handler 84
define_int_no_err_code_handler 85
define_int_no_err_code_handler 86
define_int_no_err_code_handler 87
define_int_no_err_code_handler 88
define_int_no_err_code_handler 89
define_int_no_err_code_handler 90
define_int_no_err_code_handler 91
define_int_no_err_code_handler 92
define_int_no_err_code_handler 93
define_int_no_err_code_handler 94
define_int_no_err_code_handler 95
define_int_no_err_code_handler 96
define_int_no_err_code_handler 97
define_int_no_err_code_handler 98
define_int_no_err_code_handler 99
define_int_no_err_code_handler 100
define_int_no_err_code_handler 101
define_int_no_err_code_handler 102
define_int_no_err_code_handler 103
define_int_no_err_code_handler 104
define_int_no_err_code_handler 105
define_int_no_err_code_handler 106
define_int_no_err_code_handler 107
define_int_no_err_code_handler 108
define_int_no_err_code_handler 109
define_int_no_err_code_handler 110
define_int_no_err_code_handler 111
define_int_no_err_code_handler 112
define_int_no_err_code_handler 113
define_int_no_err_code_handler 114
define_int_no_err_code_handler 115
define_int_no_err_code_handler 116
define_int_no_err_code_handler 117
define_int_no_err_code_handler 118
define_int_no_err_code_handler 119
define_int_no_err_code_handler 120
define_int_no_err_code_handler 121
define_int_no_err_code_handler 122
define_int_no_err_code_handler 123
define_int_no_err_code_handler 124
define_int_no_err_code_handler 125
define_int_no_err_code_handler 126
define_int_no_err_code_handler 127
define_int_no_err_code_handler 128
define_int_no_err_code_handler 129
define_int_no_err_code_handler 130
define_int_no_err_code_handler 131
define_int_no_err_code_handler 132
define_int_no_err_code_handler 133
define_int_no_err_code_handler 134
define_int_no_err_code_handler 135
define_int_no_err_code_handler 136
define_int_no_err_code_handler 137
define_int_no_err_code_handler 138
define_int_no_err_code_handler 139
define_int_no_err_code_handler 140
define_int_no_err_code_handler 141
define_int_no_err_code_handler 142
define_int_no_err_code_handler 143
define_int_no_err_code_handler 144
define_int_no_err_code_handler 145
define_int_no_err_code_handler 146
define_int_no_err_code_handler 147
define_int_no_err_code_handler 148
define_int_no_err_code_handler 149
define_int_no_err_code_handler 150
define_int_no_err_code_handler 151
define_int_no_err_code_handler 152
define_int_no_err_code_handler 153
define_int_no_err_code_handler 154
define_int_no_err_code_handler 155
define_int_no_err_code_handler 156
define_int_no_err_code_handler 157
define_int_no_err_code_handler 158
define_int_no_err_code_handler 159
define_int_no_err_code_handler 160
define_int_no_err_code_handler 161
define_int_no_err_code_handler 162
define_int_no_err_code_handler 163
define_int_no_err_code_handler 164
define_int_no_err_code_handler 165
define_int_no_err_code_handler 166
define_int_no_err_code_handler 167
define_int_no_err_code_handler 168
define_int_no_err_code_handler 169
define_int_no_err_code_handler 170
define_int_no_err_code_handler 171
define_int_no_err_code_handler 172
define_int_no_err_code_handler 173
define_int_no_err_code_handler 174
define_int_no_err_code_handler 175
define_int_no_err_code_handler 176
define_int_no_err_code_handler 177
define_int_no_err_code_handler 178
define_int_no_err_code_handler 179
define_int_no_err_code_handler 180
define_int_no_err_code_handler 181
define_int_no_err_code_handler 182
define_int_no_err_code_handler 183
define_int_no_err_code_handler 184
define_int_no_err_code_handler 185
define_int_no_err_code_handler 186
define_int_no_err_code_handler 187
define_int_no_err_code_handler 188
define_int_no_err_code_handler 189
define_int_no_err_code_handler 190
define_int_no_err_code_handler 191
define_int_no_err_code_handler 192
define_int_no_err_code_handler 193
define_int_no_err_code_handler 194
define_int_no_err_code_handler 195
define_int_no_err_code_handler 196
define_int_no_err_code_handler 197
define_int_no_err_code_handler 198
define_int_no_err_code_handler 199
define_int_no_err_code_handler 200
define_int_no_err_code_handler 201
define_int_no_err_code_handler 202
define_int_no_err_code_handler 203
define_int_no_err_code_handler 204
define_int_no_err_code_handler 205
define_int_no_err_code_handler 206
define_int_no_err_code_handler 207
define_int_no_err_code_handler 208
define_int_no_err_code_handler 209
define_int_no_err_code_handler 210
define_int_no_err_code_handler 211
define_int_no_err_code_handler 212
define_int_no_err_code_handler 213
define_int_no_err_code_handler 214
define_int_no_err_code_handler 215
define_int_no_err_code_handler 216
define_int_no_err_code_handler 217
define_int_no_err_code_handler 218
define_int_no_err_code_handler 219
define_int_no_err_code_handler 220
define_int_no_err_code_handler 221
define_int_no_err_code_handler 222
define_int_no_err_code_handler 223
define_int_no_err_code_handler 224
define_int_no_err_code_handler 225
define_int_no_err_code_handler 226
define_int_no_err_code_handler 227
define_int_no_err_code_handler 228
define_int_no_err_code_handler 229
define_int_no_err_code_handler 230
define_int_no_err_code_handler 231
define_int_no_err_code_handler 232
define_int_no_err_code_handler 233
define_int_no_err_code_handler 234
define_int_no_err_code_handler 235
define_int_no_err_code_handler 236
define_int_no_err_code_handler 237
define_int_no_err_code_handler 238
define_int_no_err_code_handler 239
define_int_no_err_code_handler 240
define_int_no_err_code_handler 241
define_int_no_err_code_handler 242
define_int_no_err_code_handler 243
define_int_no_err_code_handler 244
define_int_no_err_code_handler 245
define_int_no_err_code_handler 246
define_int_no_err_code_handler 247
define_int_no_err_code_handler 248
define_int_no_err_code_handler 249
define_int_no_err_code_handler 250
define_int_no_err_code_handler 251
define_int_no_err_code_handler 252
define_int_no_err_code_handler 253
define_int_no_err_code_handler 254
define_int_no_err_code_handler 255